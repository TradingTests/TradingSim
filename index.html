<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spot Trading • Nobitex Public APIs + LocalStorage</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root { color-scheme: dark; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(148,163,184,.35); border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,.5); }

    .glass { background: rgba(2, 6, 23, 0.55); backdrop-filter: blur(10px); }
    .ring-soft { box-shadow: 0 0 0 1px rgba(148,163,184,.18) inset; }

    .skeleton { position: relative; overflow: hidden; }
    .skeleton::after {
      content: "";
      position: absolute;
      top: 0; left: -150%;
      width: 150%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent);
      animation: shimmer 1.1s infinite;
    }
    @keyframes shimmer { 100% { left: 150%; } }

    canvas { image-rendering: auto; }
    
    .order-row:hover { background: rgba(148,163,184,.08); }
    .order-row { cursor: pointer; transition: background .15s; }
    
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
  </style>
</head>
<body class="h-full bg-slate-950 text-slate-100">
  <div class="min-h-full">
    <!-- Header -->
    <header class="sticky top-0 z-40 border-b border-slate-800/70 bg-slate-950/80 backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-indigo-500 to-cyan-400 grid place-items-center ring-soft">
            <span class="font-black">ST</span>
          </div>
          <div>
            <div class="font-semibold leading-tight">Spot Trading</div>
            <div class="text-xs text-slate-400">Nobitex public market data + LocalStorage portfolio</div>
          </div>
        </div>
        <div class="flex items-center gap-2 sm:gap-3">
          <div class="hidden md:flex items-center gap-2">
            <span id="connDot" class="inline-block h-2.5 w-2.5 rounded-full bg-slate-600"></span>
            <span id="connText" class="text-xs text-slate-300">Idle</span>
            <span class="text-xs text-slate-600">•</span>
            <span id="lastUpdate" class="text-xs text-slate-400">—</span>
          </div>
          <div id="pendingBadge" class="hidden items-center gap-1 px-2 py-1 rounded-lg bg-amber-950/50 border border-amber-900/50">
            <span class="h-2 w-2 rounded-full bg-amber-500 pulse-dot"></span>
            <span class="text-xs text-amber-200"><span id="pendingCount">0</span> pending</span>
          </div>
          <button id="btnExport" class="hidden sm:inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm bg-slate-900 hover:bg-slate-800 border border-slate-800">
            Export
          </button>
          <button id="btnImport" class="hidden sm:inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm bg-slate-900 hover:bg-slate-800 border border-slate-800">
            Import
          </button>
          <button id="btnSettings" class="inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm bg-indigo-600 hover:bg-indigo-500">
            Settings
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">
        <!-- Left column -->
        <section class="lg:col-span-4 space-y-5">
          <!-- Account / summary -->
          <div class="glass ring-soft rounded-2xl p-4">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-sm text-slate-400">Account</div>
                <div class="mt-1 flex flex-wrap items-center gap-2">
                  <div class="text-xl font-semibold"><span id="equity">—</span> <span id="targetBadge" class="text-sm text-slate-400">—</span></div>
                </div>
                <div class="mt-2 flex flex-wrap gap-2">
                  <span id="pnlPill" class="text-xs rounded-full px-2 py-1 border border-slate-800 bg-slate-900">P&L: —</span>
                  <span id="realizedPill" class="text-xs rounded-full px-2 py-1 border border-slate-800 bg-slate-900">Realized: —</span>
                </div>
                <div class="mt-2 text-xs text-slate-400">
                  Cash: <span id="cash">—</span>
                  <span class="text-slate-600">•</span>
                  Fee: <span id="fee">—</span>
                </div>
              </div>
              <div class="flex flex-col items-end gap-2">
                <button id="btnRefreshPrices" class="inline-flex items-center justify-center rounded-xl px-3 py-2 text-xs bg-slate-900 hover:bg-slate-800 border border-slate-800">Refresh</button>
                <button id="btnReset" class="inline-flex items-center justify-center rounded-xl px-3 py-2 text-xs bg-slate-900 hover:bg-slate-800 border border-slate-800 text-rose-200">Reset</button>
              </div>
            </div>
          </div>

          <!-- Market selector -->
          <div class="glass ring-soft rounded-2xl p-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-sm text-slate-400">Market</div>
                <div class="mt-1 font-semibold flex items-center gap-2">
                  <span id="marketSymbol" class="text-lg">—</span>
                </div>
              </div>
              <button id="btnRefreshMarket" class="inline-flex rounded-xl px-3 py-2 text-sm bg-slate-900 hover:bg-slate-800 border border-slate-800">Refresh</button>
            </div>

            <div class="mt-4">
              <label class="text-xs text-slate-400">Symbol</label>
              <div class="mt-1 flex gap-2">
                <input id="symbolInput" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-600" placeholder="BTCUSDT" />
                <button id="btnSetSymbol" class="rounded-xl px-3 py-2 text-sm bg-indigo-600 hover:bg-indigo-500">Set</button>
              </div>
              <div class="mt-2 flex flex-wrap gap-2" id="symbolChips"></div>
            </div>

            <!-- Price ticker -->
            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="rounded-xl bg-slate-900/60 border border-slate-800 p-3">
                <div class="text-xs text-slate-400">Best Ask (sell orders)</div>
                <div id="bestAsk" class="mt-1 font-semibold text-rose-200">—</div>
              </div>
              <div class="rounded-xl bg-slate-900/60 border border-slate-800 p-3">
                <div class="text-xs text-slate-400">Best Bid (buy orders)</div>
                <div id="bestBid" class="mt-1 font-semibold text-emerald-200">—</div>
              </div>
            </div>
          </div>

          <!-- Orderbook -->
          <div class="glass ring-soft rounded-2xl overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
              <div class="text-sm font-semibold">Order Book</div>
              <div class="text-xs text-slate-400">Click to fill price</div>
            </div>
            <div class="grid grid-cols-2 divide-x divide-slate-800">
              <div class="p-3">
                <div class="text-xs text-slate-400 mb-2 flex justify-between">
                  <span>Bid Price</span>
                  <span>Amount</span>
                </div>
                <div id="bids" class="space-y-0.5 text-xs"></div>
              </div>
              <div class="p-3">
                <div class="text-xs text-slate-400 mb-2 flex justify-between">
                  <span>Ask Price</span>
                  <span>Amount</span>
                </div>
                <div id="asks" class="space-y-0.5 text-xs"></div>
              </div>
            </div>
            <div class="px-4 py-2 border-t border-slate-800 bg-slate-900/40">
              <div class="flex items-center justify-between">
                <span class="text-xs text-slate-400">Spread</span>
                <span id="spread" class="text-xs font-mono">—</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Right column -->
        <section class="lg:col-span-8 space-y-5">
          <!-- Spot Trading Panel -->
          <div class="glass ring-soft rounded-2xl p-4">
            <div class="flex items-center justify-between gap-3 mb-4">
              <div>
                <div class="text-sm text-slate-400">Spot Trading</div>
                <div class="mt-1 font-semibold text-lg"><span id="tradeAsset">—</span> / <span id="tradeQuote">—</span></div>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-400">Last Price</div>
                <div id="lastPrice" class="font-semibold text-xl">—</div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Buy Panel -->
              <div class="rounded-2xl border border-emerald-900/40 bg-emerald-950/10 p-4">
                <div class="flex items-center justify-between mb-4">
                  <div class="text-lg font-bold text-emerald-400">Buy</div>
                  <div class="text-xs text-slate-400">
                    Available: <span id="buyAvailable" class="text-emerald-200 font-semibold">—</span>
                  </div>
                </div>
                
                <div class="space-y-4">
                  <div>
                    <div class="flex items-center justify-between mb-1">
                      <label class="text-xs text-slate-400">Limit Price</label>
                      <button id="btnBuyMarket" class="text-xs text-emerald-400 hover:text-emerald-300">Use Market</button>
                    </div>
                    <div class="relative">
                      <input id="buyPriceInput" type="number" step="any" min="0" class="w-full rounded-xl bg-slate-950 border border-emerald-900/40 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600 pr-16" placeholder="Enter limit price" />
                      <span id="buyPriceUnit" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">USDT</span>
                    </div>
                    <div id="buyPriceHint" class="mt-1 text-xs text-slate-500">Best ask: —</div>
                  </div>
                  
                  <div>
                    <label class="text-xs text-slate-400 mb-1 block">Amount</label>
                    <div class="relative">
                      <input id="buyAmountInput" type="number" step="any" min="0" class="w-full rounded-xl bg-slate-950 border border-emerald-900/40 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600 pr-16" placeholder="0.00" />
                      <span id="buyAmountUnit" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">BTC</span>
                    </div>
                    <div class="mt-2 flex gap-1" id="buyQuickBtns">
                      <button data-pct="0.25" class="flex-1 text-xs py-1.5 rounded-lg border border-emerald-900/40 bg-emerald-950/30 hover:bg-emerald-900/30 text-emerald-200">25%</button>
                      <button data-pct="0.50" class="flex-1 text-xs py-1.5 rounded-lg border border-emerald-900/40 bg-emerald-950/30 hover:bg-emerald-900/30 text-emerald-200">50%</button>
                      <button data-pct="0.75" class="flex-1 text-xs py-1.5 rounded-lg border border-emerald-900/40 bg-emerald-950/30 hover:bg-emerald-900/30 text-emerald-200">75%</button>
                      <button data-pct="1.00" class="flex-1 text-xs py-1.5 rounded-lg border border-emerald-900/40 bg-emerald-950/30 hover:bg-emerald-900/30 text-emerald-200">100%</button>
                    </div>
                  </div>
                  
                  <div class="rounded-xl bg-slate-950/50 border border-slate-800 p-3 space-y-2">
                    <div class="flex justify-between text-xs">
                      <span class="text-slate-400">Order Value</span>
                      <span id="buySubtotal" class="text-slate-200">—</span>
                    </div>
                    <div class="flex justify-between text-xs">
                      <span class="text-slate-400">Fee</span>
                      <span id="buyFee" class="text-slate-200">—</span>
                    </div>
                    <div class="flex justify-between text-sm font-semibold border-t border-slate-800 pt-2">
                      <span class="text-slate-300">Total Cost</span>
                      <span id="buyTotal" class="text-emerald-200">—</span>
                    </div>
                  </div>
                  
                  <div id="buyStatus" class="text-xs text-center py-2 rounded-lg hidden"></div>
                  
                  <button id="btnBuy" class="w-full rounded-xl px-4 py-3.5 font-bold text-white bg-emerald-600 hover:bg-emerald-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Buy <span id="buyBtnAsset">—</span>
                  </button>
                </div>
              </div>
              
              <!-- Sell Panel -->
              <div class="rounded-2xl border border-rose-900/40 bg-rose-950/10 p-4">
                <div class="flex items-center justify-between mb-4">
                  <div class="text-lg font-bold text-rose-400">Sell</div>
                  <div class="text-xs text-slate-400">
                    Available: <span id="sellAvailable" class="text-rose-200 font-semibold">—</span>
                  </div>
                </div>
                
                <div class="space-y-4">
                  <div>
                    <div class="flex items-center justify-between mb-1">
                      <label class="text-xs text-slate-400">Limit Price</label>
                      <button id="btnSellMarket" class="text-xs text-rose-400 hover:text-rose-300">Use Market</button>
                    </div>
                    <div class="relative">
                      <input id="sellPriceInput" type="number" step="any" min="0" class="w-full rounded-xl bg-slate-950 border border-rose-900/40 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-rose-600 pr-16" placeholder="Enter limit price" />
                      <span id="sellPriceUnit" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">USDT</span>
                    </div>
                    <div id="sellPriceHint" class="mt-1 text-xs text-slate-500">Best bid: —</div>
                  </div>
                  
                  <div>
                    <label class="text-xs text-slate-400 mb-1 block">Amount</label>
                    <div class="relative">
                      <input id="sellAmountInput" type="number" step="any" min="0" class="w-full rounded-xl bg-slate-950 border border-rose-900/40 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-rose-600 pr-16" placeholder="0.00" />
                      <span id="sellAmountUnit" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">BTC</span>
                    </div>
                    <div class="mt-2 flex gap-1" id="sellQuickBtns">
                      <button data-pct="0.25" class="flex-1 text-xs py-1.5 rounded-lg border border-rose-900/40 bg-rose-950/30 hover:bg-rose-900/30 text-rose-200">25%</button>
                      <button data-pct="0.50" class="flex-1 text-xs py-1.5 rounded-lg border border-rose-900/40 bg-rose-950/30 hover:bg-rose-900/30 text-rose-200">50%</button>
                      <button data-pct="0.75" class="flex-1 text-xs py-1.5 rounded-lg border border-rose-900/40 bg-rose-950/30 hover:bg-rose-900/30 text-rose-200">75%</button>
                      <button data-pct="1.00" class="flex-1 text-xs py-1.5 rounded-lg border border-rose-900/40 bg-rose-950/30 hover:bg-rose-900/30 text-rose-200">100%</button>
                    </div>
                  </div>
                  
                  <div class="rounded-xl bg-slate-950/50 border border-slate-800 p-3 space-y-2">
                    <div class="flex justify-between text-xs">
                      <span class="text-slate-400">Order Value</span>
                      <span id="sellSubtotal" class="text-slate-200">—</span>
                    </div>
                    <div class="flex justify-between text-xs">
                      <span class="text-slate-400">Fee</span>
                      <span id="sellFee" class="text-slate-200">—</span>
                    </div>
                    <div class="flex justify-between text-sm font-semibold border-t border-slate-800 pt-2">
                      <span class="text-slate-300">You Receive</span>
                      <span id="sellTotal" class="text-rose-200">—</span>
                    </div>
                  </div>
                  
                  <div id="sellStatus" class="text-xs text-center py-2 rounded-lg hidden"></div>
                  
                  <button id="btnSell" class="w-full rounded-xl px-4 py-3.5 font-bold text-white bg-rose-600 hover:bg-rose-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Sell <span id="sellBtnAsset">—</span>
                  </button>
                </div>
              </div>
            </div>
            
            <div id="tradeHint" class="mt-4 text-xs text-slate-400 text-center">Limit orders wait for matching liquidity • Checked every 5 seconds</div>
          </div>

          <!-- Open Orders -->
          <div class="glass ring-soft rounded-2xl overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="text-sm font-semibold">Open Orders</div>
                <span id="openOrdersCount" class="text-xs px-2 py-0.5 rounded-full bg-slate-800 text-slate-300">0</span>
              </div>
              <button id="btnCancelAllOrders" class="rounded-xl px-2 py-1.5 text-xs bg-slate-900 hover:bg-slate-800 border border-slate-800 text-rose-200">Cancel All</button>
            </div>
            <div id="openOrdersList" class="p-4 max-h-[200px] overflow-auto">
              <div id="noOpenOrders" class="text-sm text-slate-400 text-center py-4">No open orders</div>
            </div>
          </div>

          <!-- Portfolio -->
          <div class="glass ring-soft rounded-2xl overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Portfolio</div>
                <div class="text-xs text-slate-400">Your holdings</div>
              </div>
              <div class="text-xs text-slate-400">LocalStorage</div>
            </div>
            <div class="p-4 overflow-auto max-h-[250px]">
              <table class="w-full text-sm">
                <thead class="text-xs text-slate-400">
                  <tr class="border-b border-slate-800">
                    <th class="text-left py-2">Asset</th>
                    <th class="text-right py-2">Amount</th>
                    <th class="text-right py-2">Avg Cost</th>
                    <th class="text-right py-2">Value</th>
                    <th class="text-right py-2">P&L</th>
                  </tr>
                </thead>
                <tbody id="portfolioBody" class="align-top"></tbody>
              </table>
              <div id="portfolioEmpty" class="hidden text-sm text-slate-400 py-6 text-center">No holdings yet. Start trading!</div>
            </div>
          </div>

          <!-- Chart + Recent trades -->
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-5">
            <div class="glass ring-soft rounded-2xl overflow-hidden">
              <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
                <div class="text-sm font-semibold">Price Chart</div>
                <div class="flex items-center gap-2">
                  <select id="resolution" class="rounded-xl bg-slate-900 border border-slate-800 px-2 py-1.5 text-xs">
                    <option value="5">5m</option>
                    <option value="15">15m</option>
                    <option value="60" selected>1h</option>
                    <option value="240">4h</option>
                    <option value="D">1D</option>
                  </select>
                  <button id="btnReloadChart" class="rounded-xl px-2 py-1.5 text-xs bg-slate-900 hover:bg-slate-800 border border-slate-800">↻</button>
                </div>
              </div>
              <div class="p-4">
                <canvas id="chart" class="w-full h-[180px] rounded-xl border border-slate-800 bg-slate-900/40"></canvas>
                <div class="mt-2 text-xs text-slate-400" id="chartMeta">—</div>
              </div>
            </div>

            <div class="glass ring-soft rounded-2xl overflow-hidden">
              <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
                <div class="text-sm font-semibold">Trade History</div>
                <button id="btnClearHistory" class="rounded-xl px-2 py-1.5 text-xs bg-slate-900 hover:bg-slate-800 border border-slate-800 text-rose-200">Clear</button>
              </div>
              <div id="tradeHistory" class="p-4 max-h-[220px] overflow-auto"></div>
            </div>
          </div>

          <!-- Recent market trades -->
          <div class="glass ring-soft rounded-2xl overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
              <div class="text-sm font-semibold">Recent Market Trades</div>
              <div class="text-xs text-slate-400">Live feed</div>
            </div>
            <div id="recentTrades" class="p-4 max-h-[180px] overflow-auto text-xs"></div>
          </div>
        </section>
      </div>

      <div class="mt-6 text-xs text-slate-500 text-center">
        Simulation only • No real orders • Prices from public Nobitex API
      </div>
    </main>
  </div>

  <!-- Modal: Settings -->
  <div id="settingsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-2xl border border-slate-800 bg-slate-950 ring-soft overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-800 flex items-center justify-between">
          <div>
            <div class="font-semibold">Settings</div>
            <div class="text-xs text-slate-400">Configure your trading simulation</div>
          </div>
          <button id="btnCloseSettings" class="rounded-xl px-3 py-2 text-sm bg-slate-900 hover:bg-slate-800 border border-slate-800">Close</button>
        </div>
        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-400">Quote Currency</label>
            <select id="targetSelect" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm">
              <option value="USDT">USDT</option>
              <option value="IRT">IRT</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-400">Starting Balance</label>
            <input id="initialInput" type="number" step="any" min="0" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm" placeholder="1000" />
          </div>
          <div>
            <label class="text-xs text-slate-400">Trading Fee (bps)</label>
            <input id="feeInput" type="number" step="1" min="0" max="200" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm" placeholder="10" />
            <div class="mt-1 text-xs text-slate-500">10 bps = 0.10%</div>
          </div>
          <div>
            <label class="text-xs text-slate-400">Default Symbol</label>
            <input id="defaultSymbolInput" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm" placeholder="BTCUSDT" />
          </div>

          <div class="md:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div class="text-sm font-semibold text-rose-200">Danger Zone</div>
            <div class="mt-1 text-xs text-slate-400">Changing quote currency will reset your portfolio.</div>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="btnApplySettings" class="rounded-xl px-4 py-2 font-semibold bg-indigo-600 hover:bg-indigo-500">Apply</button>
              <button id="btnHardReset" class="rounded-xl px-4 py-2 font-semibold bg-rose-600 hover:bg-rose-500">Reset Everything</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Import -->
  <div id="importModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-2xl border border-slate-800 bg-slate-950 ring-soft overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-800 flex items-center justify-between">
          <div>
            <div class="font-semibold">Import State</div>
            <div class="text-xs text-slate-400">Paste exported JSON</div>
          </div>
          <button id="btnCloseImport" class="rounded-xl px-3 py-2 text-sm bg-slate-900 hover:bg-slate-800 border border-slate-800">Close</button>
        </div>
        <div class="p-5">
          <textarea id="importText" class="w-full h-48 rounded-2xl bg-slate-900 border border-slate-800 p-3 text-xs font-mono" placeholder='{ "version": 1, ... }'></textarea>
          <div class="mt-3 flex gap-2">
            <button id="btnDoImport" class="rounded-xl px-4 py-2 font-semibold bg-indigo-600 hover:bg-indigo-500">Import</button>
            <button id="btnCancelImport" class="rounded-xl px-4 py-2 font-semibold bg-slate-900 hover:bg-slate-800 border border-slate-800">Cancel</button>
          </div>
          <div id="importHint" class="mt-3 text-xs text-slate-400"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="fixed bottom-4 right-4 z-[60] space-y-2"></div>

  <script>
    const LS_KEY = 'spot_trading_v2';

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => [...document.querySelectorAll(sel)];
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function nowISO() {
      const d = new Date();
      return d.toLocaleString(undefined, { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }

    function toast(msg, type='info', timeout=2600) {
      const wrap = $('#toasts');
      const div = document.createElement('div');
      const palette = {
        info: 'border-slate-800 bg-slate-950/90 text-slate-200',
        ok: 'border-emerald-900/60 bg-emerald-950/60 text-emerald-100',
        warn: 'border-amber-900/60 bg-amber-950/60 text-amber-100',
        err: 'border-rose-900/60 bg-rose-950/60 text-rose-100'
      };
      div.className = `max-w-sm rounded-2xl border px-3 py-2 text-sm shadow-lg backdrop-blur ${palette[type]||palette.info}`;
      div.textContent = msg;
      wrap.appendChild(div);
      setTimeout(() => {
        div.style.opacity = '0';
        div.style.transform = 'translateY(4px)';
        div.style.transition = 'all .25s ease';
        setTimeout(() => div.remove(), 280);
      }, timeout);
    }

    function safeNum(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : NaN;
    }

    function clamp(n, a, b) { return Math.min(b, Math.max(a, n)); }

    function fmt(n, opts={}) {
      if (!Number.isFinite(n)) return '—';
      const nf = new Intl.NumberFormat(undefined, opts);
      return nf.format(n);
    }

    function fmtMoney(n, quote) {
      if (!Number.isFinite(n)) return '—';
      const isIRT = (quote === 'IRT');
      const maxFD = isIRT ? 0 : (Math.abs(n) >= 1000 ? 2 : 6);
      return fmt(n, { maximumFractionDigits: maxFD, minimumFractionDigits: 0 });
    }

    function fmtAmount(n) {
      if (!Number.isFinite(n)) return '—';
      const maxFD = Math.abs(n) >= 1 ? 6 : 10;
      return fmt(n, { maximumFractionDigits: maxFD });
    }

    function parseSymbol(symbol) {
      const s = String(symbol || '').trim().toUpperCase();
      if (!s) return { raw: '', base: '', quote: '' };
      if (s.endsWith('USDT')) return { raw: s, base: s.slice(0, -4), quote: 'USDT' };
      if (s.endsWith('IRT')) return { raw: s, base: s.slice(0, -3), quote: 'IRT' };
      return { raw: s, base: s, quote: '' };
    }

    function feeRateFromBps(bps) {
      const b = clamp(Math.floor(Number(bps) || 0), 0, 10000);
      return b / 10000;
    }

    function setConn(state, text) {
      const dot = $('#connDot');
      const t = $('#connText');
      const map = {
        idle: ['bg-slate-600', 'Idle'],
        ok: ['bg-emerald-500', text || 'Live'],
        fetching: ['bg-indigo-500', text || 'Fetching'],
        warn: ['bg-amber-500', text || 'Warning'],
        err: ['bg-rose-500', text || 'Error']
      };
      const [cls, label] = map[state] || map.idle;
      dot.className = `inline-block h-2.5 w-2.5 rounded-full ${cls}`;
      t.textContent = label;
    }

    // State
    const DEFAULTS = {
      version: 2,
      settings: {
        target: 'USDT',
        feeBps: 10,
        defaultSymbol: 'BTCUSDT',
      },
      account: {
        initialCash: 1000,
        cash: 1000,
        realizedPnl: 0,
      },
      holdings: {},
      pendingOrders: [],
      history: [],
      ui: {
        symbol: 'BTCUSDT',
        resolution: '60'
      },
      priceCache: {}
    };

    let state = null;

    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return structuredClone(DEFAULTS);
        const parsed = JSON.parse(raw);
        return {
          ...structuredClone(DEFAULTS),
          ...parsed,
          settings: { ...structuredClone(DEFAULTS.settings), ...(parsed.settings||{}) },
          account: { ...structuredClone(DEFAULTS.account), ...(parsed.account||{}) },
          holdings: parsed.holdings || {},
          pendingOrders: parsed.pendingOrders || [],
          history: parsed.history || [],
          ui: { ...structuredClone(DEFAULTS.ui), ...(parsed.ui||{}) },
          priceCache: parsed.priceCache || {}
        };
      } catch {
        return structuredClone(DEFAULTS);
      }
    }

    function saveState() {
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function hardResetAll() {
      localStorage.removeItem(LS_KEY);
      state = structuredClone(DEFAULTS);
      saveState();
    }

    function resetPortfolio() {
      state.holdings = {};
      state.pendingOrders = [];
      state.history = [];
      state.account.cash = state.account.initialCash;
      state.account.realizedPnl = 0;
      state.priceCache = {};
      saveState();
    }

    // API
    const API = {
      orderbook: (symbol) => `https://apiv2.nobitex.ir/v3/orderbook/${encodeURIComponent(symbol)}`,
      trades: (symbol) => `https://apiv2.nobitex.ir/v2/trades/${encodeURIComponent(symbol)}`,
      ohlc: (symbol, resolution, from, to, page=1) => `https://apiv2.nobitex.ir/market/udf/history?symbol=${encodeURIComponent(symbol)}&resolution=${encodeURIComponent(resolution)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&page=${encodeURIComponent(page)}`,
    };

    async function fetchJSON(url, { timeoutMs = 10000 } = {}) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        setConn('fetching', 'Fetching');
        const res = await fetch(url, { signal: ctrl.signal, headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        setConn('ok', 'Live');
        $('#lastUpdate').textContent = nowISO();
        return data;
      } finally {
        clearTimeout(t);
      }
    }

    // Market data
    let live = {
      symbol: '',
      orderbook: null,
      trades: null,
      bestBid: NaN,
      bestAsk: NaN,
      mid: NaN,
      lastUpdate: 0,
      lastTradePrice: NaN,
      bids: [],
      asks: []
    };

    // Cache for multiple symbols
    let marketCache = {};

    function normalizeOrderRow(row) {
      const p = safeNum(row?.[0]);
      const a = safeNum(row?.[1]);
      return { price: p, amount: a };
    }

    function computeTop(orderbook) {
      const bids = (orderbook?.bids || []).map(normalizeOrderRow).filter(x => Number.isFinite(x.price) && Number.isFinite(x.amount));
      const asks = (orderbook?.asks || []).map(normalizeOrderRow).filter(x => Number.isFinite(x.price) && Number.isFinite(x.amount));
      const bestBid = bids.length ? bids[0].price : NaN;
      const bestAsk = asks.length ? asks[0].price : NaN;
      const mid = (Number.isFinite(bestBid) && Number.isFinite(bestAsk)) ? (bestBid + bestAsk) / 2 : NaN;
      return { bids, asks, bestBid, bestAsk, mid };
    }

    async function refreshOrderbook(symbol) {
      const data = await fetchJSON(API.orderbook(symbol));
      if (data?.status !== 'ok') throw new Error('Orderbook status not ok');
      const top = computeTop(data);
      
      // Update cache for this symbol
      marketCache[symbol] = {
        bestBid: top.bestBid,
        bestAsk: top.bestAsk,
        mid: top.mid,
        bids: top.bids,
        asks: top.asks,
        ts: Date.now()
      };
      
      // If current symbol, update live
      if (symbol === state.ui.symbol) {
        live.orderbook = data;
        live.bestBid = top.bestBid;
        live.bestAsk = top.bestAsk;
        live.mid = top.mid;
        live.bids = top.bids;
        live.asks = top.asks;
        live.lastUpdate = data.lastUpdate || Date.now();
        live.lastTradePrice = safeNum(data.lastTradePrice);
      }

      state.priceCache[symbol] = {
        mid: top.mid,
        bestBid: top.bestBid,
        bestAsk: top.bestAsk,
        ts: Date.now()
      };
      saveState();
      return top;
    }

    async function refreshTrades(symbol) {
      const data = await fetchJSON(API.trades(symbol));
      if (data?.status !== 'ok') throw new Error('Trades status not ok');
      live.trades = data.trades || [];
      return live.trades;
    }

    // Symbol chips
    const POPULAR = {
      USDT: ['BTCUSDT','ETHUSDT','TONUSDT','SOLUSDT','XRPUSDT','DOGEUSDT','BNBUSDT','TRXUSDT'],
      IRT:  ['BTCIRT','ETHIRT','USDTIRT','TONIRT','XRPIRT','DOGEIRT']
    };

    function renderSymbolChips() {
      const target = state.settings.target;
      const wrap = $('#symbolChips');
      wrap.innerHTML = '';
      const chips = POPULAR[target] || [];
      for (const s of chips) {
        const b = document.createElement('button');
        b.className = `text-xs px-2 py-1 rounded-full border border-slate-800 bg-slate-900 hover:bg-slate-800 ${state.ui.symbol === s ? 'border-indigo-600/70 text-indigo-200' : 'text-slate-200'}`;
        b.textContent = s;
        b.addEventListener('click', () => setSymbol(s, { user: true }));
        wrap.appendChild(b);
      }
    }

    // Trading
    function canTradeSymbol(sym) {
      const p = parseSymbol(sym);
      return p.quote && p.quote === state.settings.target;
    }

    function getHolding(asset) {
      return state.holdings[asset] || { amount: 0, cost: 0 };
    }

    function getLockedAmount(asset, side) {
      // Calculate amount locked in pending orders
      let locked = 0;
      for (const order of state.pendingOrders) {
        if (side === 'buy' && order.side === 'buy') {
          // For buy orders, lock cash
          const p = parseSymbol(order.symbol);
          if (p.quote === state.settings.target) {
            locked += order.totalCost;
          }
        } else if (side === 'sell' && order.side === 'sell') {
          // For sell orders, lock asset
          const p = parseSymbol(order.symbol);
          if (p.base === asset) {
            locked += order.amount;
          }
        }
      }
      return locked;
    }

    function getAvailableCash() {
      return state.account.cash - getLockedAmount(null, 'buy');
    }

    function getAvailableAsset(asset) {
      const holding = getHolding(asset).amount;
      return holding - getLockedAmount(asset, 'sell');
    }

    function getCachedMid(symbol) {
      const c = state.priceCache[symbol];
      if (!c) return NaN;
      if (!Number.isFinite(c.mid)) return NaN;
      return c.mid;
    }

    function calcEquity() {
      let total = state.account.cash;
      const target = state.settings.target;
      for (const [asset, h] of Object.entries(state.holdings)) {
        const sym = `${asset}${target}`;
        const mid = getCachedMid(sym);
        if (Number.isFinite(mid)) total += h.amount * mid;
      }
      return total;
    }

    function addHistory(entry) {
      state.history.unshift(entry);
      state.history = state.history.slice(0, 200);
    }

    // Check if order can be filled using cached market data
    function canFillOrder(order, marketData) {
      const { side, limitPrice, amount } = order;
      const { bestBid, bestAsk } = marketData;
      
      if (side === 'buy') {
        if (!Number.isFinite(bestAsk)) {
          return { canFill: false, reason: 'No sellers', execPrice: NaN };
        }
        if (!Number.isFinite(limitPrice) || limitPrice <= 0) {
          return { canFill: true, reason: null, execPrice: bestAsk };
        }
        if (limitPrice >= bestAsk) {
          return { canFill: true, reason: null, execPrice: bestAsk };
        }
        return { canFill: false, reason: `Limit ${limitPrice} < Ask ${bestAsk}`, execPrice: NaN };
      }
      
      if (side === 'sell') {
        if (!Number.isFinite(bestBid)) {
          return { canFill: false, reason: 'No buyers', execPrice: NaN };
        }
        if (!Number.isFinite(limitPrice) || limitPrice <= 0) {
          return { canFill: true, reason: null, execPrice: bestBid };
        }
        if (limitPrice <= bestBid) {
          return { canFill: true, reason: null, execPrice: bestBid };
        }
        return { canFill: false, reason: `Limit ${limitPrice} > Bid ${bestBid}`, execPrice: NaN };
      }
      
      return { canFill: false, reason: 'Unknown side', execPrice: NaN };
    }

    function executeFilledOrder(order, execPrice) {
      const p = parseSymbol(order.symbol);
      const feeRate = feeRateFromBps(state.settings.feeBps);
      
      if (order.side === 'buy') {
        const subtotal = order.amount * execPrice;
        const fee = subtotal * feeRate;
        const total = subtotal + fee;

        const prev = getHolding(p.base);
        const next = {
          amount: prev.amount + order.amount,
          cost: prev.cost + total
        };
        state.holdings[p.base] = next;
        state.account.cash -= total;

        addHistory({
          ts: Date.now(),
          side: 'buy',
          symbol: order.symbol,
          asset: p.base,
          quote: p.quote,
          amount: order.amount,
          price: execPrice,
          limitPrice: order.limitPrice,
          fee,
          total,
          realized: 0,
          orderId: order.id,
          wasQueued: order.createdAt < Date.now() - 1000
        });

        return { price: execPrice, fee, total };
      }

      if (order.side === 'sell') {
        const prev = getHolding(p.base);
        const subtotal = order.amount * execPrice;
        const fee = subtotal * feeRate;
        const net = subtotal - fee;

        const avgCost = prev.cost / prev.amount;
        const costOut = avgCost * order.amount;
        const realized = net - costOut;

        const remainingAmt = prev.amount - order.amount;
        const remainingCost = prev.cost - costOut;

        if (remainingAmt <= 1e-12) {
          delete state.holdings[p.base];
        } else {
          state.holdings[p.base] = { amount: remainingAmt, cost: remainingCost };
        }

        state.account.cash += net;
        state.account.realizedPnl += realized;

        addHistory({
          ts: Date.now(),
          side: 'sell',
          symbol: order.symbol,
          asset: p.base,
          quote: p.quote,
          amount: order.amount,
          price: execPrice,
          limitPrice: order.limitPrice,
          fee,
          total: net,
          realized,
          orderId: order.id,
          wasQueued: order.createdAt < Date.now() - 1000
        });

        return { price: execPrice, fee, total: net, realized };
      }
    }

    function createOrder(side, symbol, amount, limitPrice) {
      const p = parseSymbol(symbol);
      if (!p.quote || p.quote !== state.settings.target) {
        throw new Error(`Quote currency mismatch`);
      }
      if (!Number.isFinite(amount) || amount <= 0) throw new Error('Invalid amount');

      const feeRate = feeRateFromBps(state.settings.feeBps);
      const effectiveLimit = (Number.isFinite(limitPrice) && limitPrice > 0) ? limitPrice : null;
      
      // For market orders, use current best price for validation
      const priceForCalc = effectiveLimit || (side === 'buy' ? live.bestAsk : live.bestBid);
      
      if (!Number.isFinite(priceForCalc)) {
        throw new Error('No market price available');
      }

      if (side === 'buy') {
        const subtotal = amount * priceForCalc;
        const fee = subtotal * feeRate;
        const totalCost = subtotal + fee;
        
        if (getAvailableCash() + 1e-12 < totalCost) {
          throw new Error('Insufficient available balance');
        }

        return {
          id: generateId(),
          side: 'buy',
          symbol,
          asset: p.base,
          quote: p.quote,
          amount,
          limitPrice: effectiveLimit,
          totalCost,
          createdAt: Date.now(),
          status: 'pending'
        };
      }

      if (side === 'sell') {
        if (getAvailableAsset(p.base) + 1e-12 < amount) {
          throw new Error('Insufficient available asset');
        }

        const subtotal = amount * priceForCalc;
        const fee = subtotal * feeRate;
        
        return {
          id: generateId(),
          side: 'sell',
          symbol,
          asset: p.base,
          quote: p.quote,
          amount,
          limitPrice: effectiveLimit,
          estimatedReceive: subtotal - fee,
          createdAt: Date.now(),
          status: 'pending'
        };
      }

      throw new Error('Unknown side');
    }

    async function placeOrder(side, symbol, amount, limitPrice) {
      // Refresh orderbook first
      await refreshOrderbook(symbol);
      
      const order = createOrder(side, symbol, amount, limitPrice);
      const marketData = { bestBid: live.bestBid, bestAsk: live.bestAsk };
      const fillCheck = canFillOrder(order, marketData);
      
      if (fillCheck.canFill) {
        // Execute immediately
        const result = executeFilledOrder(order, fillCheck.execPrice);
        saveState();
        return { filled: true, result, order };
      } else {
        // Add to pending orders
        state.pendingOrders.push(order);
        saveState();
        return { filled: false, reason: fillCheck.reason, order };
      }
    }

    function cancelOrder(orderId) {
      const idx = state.pendingOrders.findIndex(o => o.id === orderId);
      if (idx === -1) return false;
      state.pendingOrders.splice(idx, 1);
      saveState();
      return true;
    }

    function cancelAllOrders() {
      const count = state.pendingOrders.length;
      state.pendingOrders = [];
      saveState();
      return count;
    }

    // Check and execute pending orders
    async function checkPendingOrders() {
      if (state.pendingOrders.length === 0) return;
      
      // Get unique symbols from pending orders
      const symbols = [...new Set(state.pendingOrders.map(o => o.symbol))];
      
      // Refresh orderbook for each symbol
      for (const sym of symbols) {
        try {
          await refreshOrderbook(sym);
        } catch (e) {
          console.warn(`Failed to refresh ${sym}:`, e);
        }
        await sleep(200); // Rate limit
      }
      
      // Check each pending order
      const toRemove = [];
      const executed = [];
      
      for (const order of state.pendingOrders) {
        const cache = marketCache[order.symbol];
        if (!cache) continue;
        
        const fillCheck = canFillOrder(order, cache);
        if (fillCheck.canFill) {
          try {
            const result = executeFilledOrder(order, fillCheck.execPrice);
            toRemove.push(order.id);
            executed.push({ order, result });
          } catch (e) {
            console.warn(`Failed to execute order ${order.id}:`, e);
          }
        }
      }
      
      // Remove executed orders
      state.pendingOrders = state.pendingOrders.filter(o => !toRemove.includes(o.id));
      saveState();
      
      // Notify user
      for (const { order, result } of executed) {
        toast(`Order filled: ${order.side.toUpperCase()} ${fmtAmount(order.amount)} ${order.asset} @ ${fmtMoney(result.price, state.settings.target)}`, 'ok');
      }
      
      renderAll();
    }

    // UI rendering
    function setSymbol(symbol, { user=false } = {}) {
      const sym = String(symbol || '').trim().toUpperCase();
      if (!sym) return;
      state.ui.symbol = sym;
      saveState();
      $('#symbolInput').value = sym;
      renderSymbolChips();
      if (user) toast(`Symbol: ${sym}`, 'ok');
      scheduleMarketRefresh(true);
      scheduleChartRefresh(true);
      renderAll();
    }

    function renderAccountSummary() {
      const target = state.settings.target;
      const equity = calcEquity();
      const pnl = equity - state.account.initialCash;
      const pnlPct = state.account.initialCash > 0 ? (pnl / state.account.initialCash) * 100 : NaN;

      $('#targetBadge').textContent = target;
      $('#equity').textContent = fmtMoney(equity, target);
      $('#cash').textContent = fmtMoney(state.account.cash, target) + ` ${target}`;
      $('#fee').textContent = `${state.settings.feeBps} bps`;

      const pnlText = `${pnl >= 0 ? '+' : ''}${fmtMoney(pnl, target)} (${Number.isFinite(pnlPct) ? pnlPct.toFixed(2) : '—'}%)`;
      const pnlPill = $('#pnlPill');
      pnlPill.textContent = `P&L: ${pnlText}`;
      pnlPill.className = `text-xs rounded-full px-2 py-1 border ${pnl >= 0 ? 'border-emerald-900/60 bg-emerald-950/40 text-emerald-200' : 'border-rose-900/60 bg-rose-950/40 text-rose-200'}`;

      const realized = state.account.realizedPnl;
      const realizedPill = $('#realizedPill');
      realizedPill.textContent = `Realized: ${realized >= 0 ? '+' : ''}${fmtMoney(realized, target)}`;
      realizedPill.className = `text-xs rounded-full px-2 py-1 border ${realized >= 0 ? 'border-emerald-900/60 bg-emerald-950/40 text-emerald-200' : 'border-rose-900/60 bg-rose-950/40 text-rose-200'}`;
      
      // Pending badge
      const pendingCount = state.pendingOrders.length;
      const pendingBadge = $('#pendingBadge');
      if (pendingCount > 0) {
        pendingBadge.classList.remove('hidden');
        pendingBadge.classList.add('flex');
        $('#pendingCount').textContent = pendingCount;
      } else {
        pendingBadge.classList.add('hidden');
        pendingBadge.classList.remove('flex');
      }
    }

    function renderMarketSummary() {
      const sym = state.ui.symbol;
      const p = parseSymbol(sym);
      const target = state.settings.target;
      
      $('#marketSymbol').textContent = sym;
      $('#tradeAsset').textContent = p.base || '—';
      $('#tradeQuote').textContent = p.quote || '—';
      
      // Update unit labels
      $('#buyPriceUnit').textContent = p.quote || target;
      $('#sellPriceUnit').textContent = p.quote || target;
      $('#buyAmountUnit').textContent = p.base || '—';
      $('#sellAmountUnit').textContent = p.base || '—';
      $('#buyBtnAsset').textContent = p.base || '—';
      $('#sellBtnAsset').textContent = p.base || '—';
      
      // Available balances (minus locked amounts)
      $('#buyAvailable').textContent = `${fmtMoney(getAvailableCash(), target)} ${target}`;
      $('#sellAvailable').textContent = `${fmtAmount(getAvailableAsset(p.base))} ${p.base}`;

      const targetOk = canTradeSymbol(sym);
      $('#tradeHint').textContent = targetOk
        ? 'Limit orders wait for matching liquidity • Checked every 5 seconds'
        : `⚠️ Symbol must end with ${target}`;
      $('#tradeHint').className = `mt-4 text-xs text-center ${targetOk ? 'text-slate-400' : 'text-amber-200'}`;
    }

    function renderOrderbook() {
      const sym = state.ui.symbol;
      const p = parseSymbol(sym);

      const bid = live.bestBid;
      const ask = live.bestAsk;
      const mid = live.mid;
      const spread = (Number.isFinite(bid) && Number.isFinite(ask)) ? (ask - bid) : NaN;
      const lastPrice = Number.isFinite(live.lastTradePrice) ? live.lastTradePrice : mid;

      $('#bestBid').textContent = fmtMoney(bid, p.quote);
      $('#bestAsk').textContent = fmtMoney(ask, p.quote);
      $('#lastPrice').textContent = fmtMoney(lastPrice, p.quote);
      $('#spread').textContent = Number.isFinite(spread) ? `${fmtMoney(spread, p.quote)} (${((spread / mid) * 100).toFixed(3)}%)` : '—';

      const bidsEl = $('#bids');
      const asksEl = $('#asks');

      bidsEl.innerHTML = '';
      asksEl.innerHTML = '';

      const bidRows = live.bids.slice(0, 8);
      const askRows = live.asks.slice(0, 8);

      for (const r of bidRows) {
        const row = document.createElement('div');
        row.className = 'order-row flex items-center justify-between gap-2 px-1 py-0.5 rounded';
        row.innerHTML = `
          <div class="text-emerald-300 tabular-nums font-mono">${fmtMoney(r.price, p.quote)}</div>
          <div class="text-slate-400 tabular-nums font-mono text-right">${fmtAmount(r.amount)}</div>
        `;
        row.addEventListener('click', () => {
          $('#buyPriceInput').value = r.price;
          $('#sellPriceInput').value = r.price;
          renderTradePreview();
        });
        bidsEl.appendChild(row);
      }
      
      for (const r of askRows) {
        const row = document.createElement('div');
        row.className = 'order-row flex items-center justify-between gap-2 px-1 py-0.5 rounded';
        row.innerHTML = `
          <div class="text-rose-300 tabular-nums font-mono">${fmtMoney(r.price, p.quote)}</div>
          <div class="text-slate-400 tabular-nums font-mono text-right">${fmtAmount(r.amount)}</div>
        `;
        row.addEventListener('click', () => {
          $('#buyPriceInput').value = r.price;
          $('#sellPriceInput').value = r.price;
          renderTradePreview();
        });
        asksEl.appendChild(row);
      }

      if (!bidRows.length) bidsEl.innerHTML = '<div class="text-slate-500 text-center py-2">No bids</div>';
      if (!askRows.length) asksEl.innerHTML = '<div class="text-slate-500 text-center py-2">No asks</div>';

      renderTradePreview();
    }

    function renderRecentTrades() {
      const wrap = $('#recentTrades');
      const sym = state.ui.symbol;
      const p = parseSymbol(sym);
      const rows = (live.trades || []).slice(0, 15);
      if (!rows.length) {
        wrap.innerHTML = '<div class="text-slate-500 text-center">—</div>';
        return;
      }
      wrap.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const tr of rows) {
        const time = new Date(tr.time).toLocaleTimeString();
        const price = safeNum(tr.price);
        const vol = safeNum(tr.volume);
        const type = tr.type;
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between gap-2 py-1 border-b border-slate-800/40 last:border-b-0';
        el.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="text-[11px] text-slate-500 font-mono">${time}</span>
            <span class="w-8 text-center text-[10px] px-1 py-0.5 rounded ${type==='buy' ? 'bg-emerald-950/50 text-emerald-300' : 'bg-rose-950/50 text-rose-300'}">${type.toUpperCase()}</span>
          </div>
          <div class="text-right font-mono">
            <span class="${type==='buy' ? 'text-emerald-200' : 'text-rose-200'}">${fmtMoney(price, p.quote)}</span>
            <span class="text-slate-500 ml-2">${fmtAmount(vol)}</span>
          </div>
        `;
        frag.appendChild(el);
      }
      wrap.appendChild(frag);
    }

    function renderTradePreview() {
      const sym = state.ui.symbol;
      const p = parseSymbol(sym);
      const target = state.settings.target;
      const feeRate = feeRateFromBps(state.settings.feeBps);

      // Buy preview
      const buyLimitPrice = safeNum($('#buyPriceInput').value);
      const buyAmount = safeNum($('#buyAmountInput').value);
      const buyPrice = (Number.isFinite(buyLimitPrice) && buyLimitPrice > 0) ? buyLimitPrice : live.bestAsk;
      
      const buyStatus = $('#buyStatus');
      const btnBuy = $('#btnBuy');
      
      if (Number.isFinite(buyAmount) && buyAmount > 0 && Number.isFinite(buyPrice)) {
        const subtotal = buyAmount * buyPrice;
        const fee = subtotal * feeRate;
        const total = subtotal + fee;
        
        $('#buySubtotal').textContent = `${fmtMoney(subtotal, target)} ${target}`;
        $('#buyFee').textContent = `${fmtMoney(fee, target)} ${target}`;
        $('#buyTotal').textContent = `${fmtMoney(total, target)} ${target}`;
        
        const available = getAvailableCash();
        const willQueue = Number.isFinite(buyLimitPrice) && buyLimitPrice > 0 && buyLimitPrice < live.bestAsk;
        
        if (available >= total) {
          if (willQueue) {
            buyStatus.textContent = `Will be queued (limit < ask)`;
            buyStatus.className = 'text-xs text-center py-2 rounded-lg bg-amber-950/30 text-amber-300';
            buyStatus.classList.remove('hidden');
          } else {
            buyStatus.classList.add('hidden');
          }
          btnBuy.disabled = false;
        } else {
          buyStatus.textContent = 'Insufficient balance';
          buyStatus.className = 'text-xs text-center py-2 rounded-lg bg-rose-950/30 text-rose-300';
          buyStatus.classList.remove('hidden');
          btnBuy.disabled = true;
        }
      } else {
        $('#buySubtotal').textContent = '—';
        $('#buyFee').textContent = '—';
        $('#buyTotal').textContent = '—';
        buyStatus.classList.add('hidden');
        btnBuy.disabled = true;
      }

      // Sell preview
      const sellLimitPrice = safeNum($('#sellPriceInput').value);
      const sellAmount = safeNum($('#sellAmountInput').value);
      const sellPrice = (Number.isFinite(sellLimitPrice) && sellLimitPrice > 0) ? sellLimitPrice : live.bestBid;
      
      const sellStatus = $('#sellStatus');
      const btnSell = $('#btnSell');
      
      if (Number.isFinite(sellAmount) && sellAmount > 0 && Number.isFinite(sellPrice)) {
        const subtotal = sellAmount * sellPrice;
        const fee = subtotal * feeRate;
        const total = subtotal - fee;
        
        $('#sellSubtotal').textContent = `${fmtMoney(subtotal, target)} ${target}`;
        $('#sellFee').textContent = `${fmtMoney(fee, target)} ${target}`;
        $('#sellTotal').textContent = `${fmtMoney(total, target)} ${target}`;
        
        const available = getAvailableAsset(p.base);
        const willQueue = Number.isFinite(sellLimitPrice) && sellLimitPrice > 0 && sellLimitPrice > live.bestBid;
        
        if (available >= sellAmount) {
          if (willQueue) {
            sellStatus.textContent = `Will be queued (limit > bid)`;
            sellStatus.className = 'text-xs text-center py-2 rounded-lg bg-amber-950/30 text-amber-300';
            sellStatus.classList.remove('hidden');
          } else {
            sellStatus.classList.add('hidden');
          }
          btnSell.disabled = false;
        } else {
          sellStatus.textContent = 'Insufficient asset balance';
          sellStatus.className = 'text-xs text-center py-2 rounded-lg bg-rose-950/30 text-rose-300';
          sellStatus.classList.remove('hidden');
          btnSell.disabled = true;
        }
      } else {
        $('#sellSubtotal').textContent = '—';
        $('#sellFee').textContent = '—';
        $('#sellTotal').textContent = '—';
        sellStatus.classList.add('hidden');
        btnSell.disabled = true;
      }

      // Update price hints
      $('#buyPriceHint').textContent = Number.isFinite(live.bestAsk) 
        ? `Best ask: ${fmtMoney(live.bestAsk, target)} • ≥ to fill instantly` 
        : 'No asks available';
      $('#sellPriceHint').textContent = Number.isFinite(live.bestBid) 
        ? `Best bid: ${fmtMoney(live.bestBid, target)} • ≤ to fill instantly` 
        : 'No bids available';
    }

    function renderOpenOrders() {
      const wrap = $('#openOrdersList');
      const target = state.settings.target;
      const orders = state.pendingOrders;
      
      $('#openOrdersCount').textContent = orders.length;
      
      if (orders.length === 0) {
        wrap.innerHTML = '<div id="noOpenOrders" class="text-sm text-slate-400 text-center py-4">No open orders</div>';
        return;
      }
      
      wrap.innerHTML = '';
      
      for (const order of orders) {
        const age = Math.floor((Date.now() - order.createdAt) / 1000);
        const ageText = age < 60 ? `${age}s ago` : `${Math.floor(age/60)}m ago`;
        const sideCls = order.side === 'buy' 
          ? 'bg-emerald-950/50 text-emerald-300 border-emerald-900/50' 
          : 'bg-rose-950/50 text-rose-300 border-rose-900/50';
        
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-800 bg-slate-900/30 mb-2 last:mb-0';
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="h-2 w-2 rounded-full bg-amber-500 pulse-dot"></span>
            <div>
              <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-0.5 rounded border ${sideCls}">${order.side.toUpperCase()}</span>
                <span class="font-semibold">${order.asset}</span>
                <span class="text-xs text-slate-500">${ageText}</span>
              </div>
              <div class="text-xs text-slate-400 mt-1 font-mono">
                ${fmtAmount(order.amount)} @ ${order.limitPrice ? fmtMoney(order.limitPrice, target) : 'Market'} ${target}
              </div>
            </div>
          </div>
          <button class="cancel-order-btn rounded-lg px-2 py-1 text-xs bg-slate-800 hover:bg-rose-900/50 text-rose-200 border border-slate-700" data-id="${order.id}">
            Cancel
          </button>
        `;
        wrap.appendChild(div);
      }
      
      // Attach cancel handlers
      wrap.querySelectorAll('.cancel-order-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (cancelOrder(id)) {
            toast('Order cancelled', 'ok');
            renderAll();
          }
        });
      });
    }

    function renderPortfolio() {
      const target = state.settings.target;
      const tbody = $('#portfolioBody');
      tbody.innerHTML = '';

      const entries = Object.entries(state.holdings);
      if (!entries.length) {
        $('#portfolioEmpty').classList.remove('hidden');
        return;
      }
      $('#portfolioEmpty').classList.add('hidden');

      const sorted = entries
        .map(([asset, h]) => {
          const sym = `${asset}${target}`;
          const mid = getCachedMid(sym);
          const value = Number.isFinite(mid) ? h.amount * mid : NaN;
          const unr = Number.isFinite(mid) ? (h.amount * mid - h.cost) : NaN;
          return { asset, ...h, sym, mid, value, unr };
        })
        .sort((a,b) => (Number.isFinite(b.value)?b.value:-1) - (Number.isFinite(a.value)?a.value:-1));

      for (const row of sorted) {
        const avg = row.amount > 0 ? (row.cost / row.amount) : NaN;
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-800/60 last:border-b-0 hover:bg-slate-900/30 cursor-pointer';
        const unrCls = !Number.isFinite(row.unr) ? 'text-slate-400' : (row.unr >= 0 ? 'text-emerald-200' : 'text-rose-200');
        tr.innerHTML = `
          <td class="py-2">
            <div class="font-semibold">${row.asset}</div>
          </td>
          <td class="py-2 text-right tabular-nums font-mono">${fmtAmount(row.amount)}</td>
          <td class="py-2 text-right tabular-nums font-mono text-slate-400">${fmtMoney(avg, target)}</td>
          <td class="py-2 text-right tabular-nums font-mono">${fmtMoney(row.value, target)}</td>
          <td class="py-2 text-right tabular-nums font-mono ${unrCls}">${row.unr >= 0 ? '+' : ''}${fmtMoney(row.unr, target)}</td>
        `;
        tr.addEventListener('click', () => setSymbol(row.sym, { user: true }));
        tbody.appendChild(tr);
      }
    }

    function renderHistory() {
      const wrap = $('#tradeHistory');
      const target = state.settings.target;
      const rows = state.history || [];
      if (!rows.length) {
        wrap.innerHTML = '<div class="text-sm text-slate-400 text-center py-4">No trades yet</div>';
        return;
      }
      wrap.innerHTML = '';

      for (const h of rows.slice(0, 50)) {
        const t = new Date(h.ts).toLocaleString();
        const sideCls = h.side === 'buy'
          ? 'bg-emerald-950/50 text-emerald-300'
          : 'bg-rose-950/50 text-rose-300';

        const typeInfo = h.limitPrice ? `limit @ ${fmtMoney(h.limitPrice, target)}` : 'market';
        const queuedBadge = h.wasQueued ? '<span class="text-[10px] px-1 py-0.5 rounded bg-amber-950/50 text-amber-300 ml-1">queued</span>' : '';

        const div = document.createElement('div');
        div.className = 'flex items-center justify-between gap-2 py-2 border-b border-slate-800/40 last:border-b-0 text-xs';
        div.innerHTML = `
          <div class="flex items-center gap-2 flex-wrap">
            <span class="px-2 py-0.5 rounded text-[10px] font-semibold ${sideCls}">${h.side.toUpperCase()}</span>
            <span class="font-semibold">${h.asset}</span>
            ${queuedBadge}
            <span class="text-slate-500">${t}</span>
          </div>
          <div class="text-right font-mono">
            <span>${fmtAmount(h.amount)} @ ${fmtMoney(h.price, target)}</span>
          </div>
        `;
        wrap.appendChild(div);
      }
    }

    function renderAll() {
      renderAccountSummary();
      renderSymbolChips();
      renderMarketSummary();
      renderOrderbook();
      renderRecentTrades();
      renderOpenOrders();
      renderPortfolio();
      renderHistory();
    }

    // Chart
    function resizeCanvasToCSS(c) {
      const rect = c.getBoundingClientRect();
      const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      const w = Math.floor(rect.width * dpr);
      const h = Math.floor(rect.height * dpr);
      if (c.width !== w || c.height !== h) {
        c.width = w;
        c.height = h;
      }
      return { w, h, dpr };
    }

    function drawLineChart(canvas, xs, ys, { quote='USDT', title='' } = {}) {
      const { w, h } = resizeCanvasToCSS(canvas);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, w, h);

      ctx.fillStyle = 'rgba(2, 6, 23, 0.35)';
      ctx.fillRect(0, 0, w, h);

      if (!ys.length) {
        ctx.fillStyle = 'rgba(148,163,184,0.7)';
        ctx.font = `${Math.max(12, Math.floor(h/18))}px ui-sans-serif`;
        ctx.fillText('No data', 14, 24);
        return;
      }

      const pad = Math.max(28, Math.floor(w * 0.06));
      const innerW = w - pad*2;
      const innerH = h - pad*2;

      const ymin = Math.min(...ys);
      const ymax = Math.max(...ys);
      const yr = (ymax - ymin) || 1;

      const xToPx = (i) => pad + (i/(ys.length-1)) * innerW;
      const yToPx = (y) => pad + innerH - ((y - ymin)/yr) * innerH;

      ctx.strokeStyle = 'rgba(148,163,184,0.12)';
      ctx.lineWidth = 1;
      for (let i=0;i<5;i++) {
        const y = pad + (innerH/4)*i;
        ctx.beginPath();
        ctx.moveTo(pad, y);
        ctx.lineTo(pad+innerW, y);
        ctx.stroke();
      }

      const last = ys[ys.length-1];
      const first = ys[0];
      const up = last >= first;
      const stroke = up ? 'rgba(34,197,94,0.9)' : 'rgba(244,63,94,0.9)';
      const fill = up ? 'rgba(34,197,94,0.10)' : 'rgba(244,63,94,0.10)';

      ctx.beginPath();
      for (let i=0;i<ys.length;i++) {
        const x = xToPx(i);
        const y = yToPx(ys[i]);
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.lineTo(pad+innerW, pad+innerH);
      ctx.lineTo(pad, pad+innerH);
      ctx.closePath();
      ctx.fillStyle = fill;
      ctx.fill();

      ctx.fillStyle = 'rgba(226,232,240,0.9)';
      ctx.font = `${Math.max(11, Math.floor(h/22))}px ui-sans-serif`;
      ctx.fillText(title, 14, 18);
    }

    async function fetchOHLC(symbol, resolution) {
      const to = Math.floor(Date.now()/1000);
      const span = (resolution === '5') ? 2*86400
        : (resolution === '15') ? 5*86400
        : (resolution === '60') ? 14*86400
        : (resolution === '240') ? 60*86400
        : (resolution === 'D') ? 365*86400
        : 14*86400;
      const from = to - span;
      const url = API.ohlc(symbol, resolution, from, to, 1);
      const data = await fetchJSON(url);
      if (data?.s !== 'ok') throw new Error(data?.errmsg || data?.s || 'OHLC failed');
      return data;
    }

    function renderChart(data) {
      const sym = state.ui.symbol;
      const p = parseSymbol(sym);
      const c = $('#chart');
      const closes = (data?.c || []).map(Number).filter(Number.isFinite);
      const times = (data?.t || []).map(Number).filter(Number.isFinite);
      const title = `${sym} • ${state.ui.resolution}`;
      drawLineChart(c, times, closes, { quote: p.quote || state.settings.target, title });

      if (closes.length) {
        const first = closes[0];
        const last = closes[closes.length-1];
        const chg = first ? ((last-first)/first)*100 : NaN;
        $('#chartMeta').textContent = `${closes.length} candles • ${Number.isFinite(chg) ? (chg >= 0 ? '+' : '') + chg.toFixed(2) + '%' : '—'}`;
      } else {
        $('#chartMeta').textContent = '—';
      }
    }

    // Refresh scheduling
    let orderbookTimer = null;
    let tradesTimer = null;
    let pendingOrdersTimer = null;
    let chartInFlight = false;
    let marketInFlight = false;

    async function refreshMarketOnce() {
      const sym = state.ui.symbol;
      live.symbol = sym;

      try {
        marketInFlight = true;
        await refreshOrderbook(sym);
        renderOrderbook();
        renderMarketSummary();
        renderPortfolio();
        renderAccountSummary();
      } catch (e) {
        setConn('warn', 'Error');
        toast(`Refresh failed: ${e.message}`, 'warn');
      } finally {
        marketInFlight = false;
      }

      try {
        await refreshTrades(sym);
        renderRecentTrades();
      } catch (e) {
        setConn('warn', 'Trades');
      }
    }

    function scheduleMarketRefresh(immediate=false) {
      if (orderbookTimer) clearInterval(orderbookTimer);
      if (tradesTimer) clearInterval(tradesTimer);

      if (immediate) refreshMarketOnce();

      orderbookTimer = setInterval(() => {
        if (!marketInFlight) refreshOrderbook(state.ui.symbol)
          .then(() => {
            renderOrderbook();
            renderMarketSummary();
            renderPortfolio();
            renderAccountSummary();
          })
          .catch(() => setConn('warn', 'Market'));
      }, 6000);

      tradesTimer = setInterval(() => {
        refreshTrades(state.ui.symbol)
          .then(renderRecentTrades)
          .catch(() => setConn('warn', 'Trades'));
      }, 18000);
    }

    function schedulePendingOrdersCheck() {
      if (pendingOrdersTimer) clearInterval(pendingOrdersTimer);
      
      // Check pending orders every 5 seconds
      pendingOrdersTimer = setInterval(() => {
        if (state.pendingOrders.length > 0) {
          checkPendingOrders();
        }
      }, 5000);
    }

    async function refreshPortfolioPrices() {
      const target = state.settings.target;
      const assets = Object.keys(state.holdings);
      if (!assets.length) return;
      toast('Refreshing prices…', 'info', 1400);

      for (const asset of assets) {
        const sym = `${asset}${target}`;
        try {
          await refreshOrderbook(sym);
        } catch {}
        await sleep(350);
      }

      renderPortfolio();
      renderAccountSummary();
      toast('Prices updated', 'ok');
    }

    async function scheduleChartRefresh(immediate=false) {
      if (!immediate) return;
      if (chartInFlight) return;
      chartInFlight = true;
      const sym = state.ui.symbol;
      try {
        const data = await fetchOHLC(sym, state.ui.resolution);
        renderChart(data);
      } catch (e) {
        const c = $('#chart');
        const { w, h } = resizeCanvasToCSS(c);
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = 'rgba(148,163,184,0.8)';
        ctx.font = '12px ui-sans-serif';
        ctx.fillText(`Chart unavailable`, 14, 24);
        $('#chartMeta').textContent = '—';
      } finally {
        chartInFlight = false;
      }
    }

    // Settings modal
    function openSettings() {
      $('#settingsModal').classList.remove('hidden');
      $('#targetSelect').value = state.settings.target;
      $('#initialInput').value = state.account.initialCash;
      $('#feeInput').value = state.settings.feeBps;
      $('#defaultSymbolInput').value = state.settings.defaultSymbol;
    }

    function closeSettings() {
      $('#settingsModal').classList.add('hidden');
    }

    function applySettingsFromModal() {
      const nextTarget = $('#targetSelect').value;
      const nextInitial = safeNum($('#initialInput').value);
      const nextFee = clamp(Math.floor(safeNum($('#feeInput').value)), 0, 500);
      const nextDefault = String($('#defaultSymbolInput').value || '').trim().toUpperCase();

      if (!Number.isFinite(nextInitial) || nextInitial < 0) {
        toast('Invalid balance', 'err');
        return;
      }

      const targetChanged = nextTarget !== state.settings.target;

      state.settings.target = nextTarget;
      state.settings.feeBps = Number.isFinite(nextFee) ? nextFee : DEFAULTS.settings.feeBps;
      state.settings.defaultSymbol = nextDefault || `BTC${nextTarget}`;

      state.account.initialCash = nextInitial;
      state.account.cash = nextInitial;
      state.account.realizedPnl = 0;

      if (targetChanged) {
        state.holdings = {};
        state.pendingOrders = [];
        state.history = [];
        state.priceCache = {};
        const candidate = parseSymbol(state.settings.defaultSymbol).quote === nextTarget
          ? state.settings.defaultSymbol
          : `BTC${nextTarget}`;
        state.ui.symbol = candidate;
        toast('Currency changed, portfolio reset', 'warn');
      } else {
        toast('Settings saved', 'ok');
      }

      saveState();
      closeSettings();
      $('#symbolInput').value = state.ui.symbol;
      renderSymbolChips();
      renderAll();
      scheduleMarketRefresh(true);
      scheduleChartRefresh(true);
    }

    // Export / Import
    function exportState() {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `spot_export_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function openImport() {
      $('#importModal').classList.remove('hidden');
      $('#importText').value = '';
      $('#importHint').textContent = '';
    }

    function closeImport() {
      $('#importModal').classList.add('hidden');
    }

    function doImport() {
      try {
        const txt = $('#importText').value;
        const parsed = JSON.parse(txt);
        if (!parsed || typeof parsed !== 'object') throw new Error('Invalid JSON');
        if (!parsed.settings || !parsed.account) throw new Error('Missing fields');
        state = {
          ...structuredClone(DEFAULTS),
          ...parsed,
          settings: { ...structuredClone(DEFAULTS.settings), ...(parsed.settings||{}) },
          account: { ...structuredClone(DEFAULTS.account), ...(parsed.account||{}) },
          holdings: parsed.holdings || {},
          pendingOrders: parsed.pendingOrders || [],
          history: parsed.history || [],
          ui: { ...structuredClone(DEFAULTS.ui), ...(parsed.ui||{}) },
          priceCache: parsed.priceCache || {}
        };
        saveState();
        closeImport();
        renderAll();
        scheduleMarketRefresh(true);
        scheduleChartRefresh(true);
        toast('Imported successfully', 'ok');
      } catch (e) {
        $('#importHint').textContent = `Error: ${e.message}`;
      }
    }

    // Events
    function wireEvents() {
      $('#btnSettings').addEventListener('click', openSettings);
      $('#btnCloseSettings').addEventListener('click', closeSettings);
      $('#settingsModal').addEventListener('click', (e) => {
        if (e.target === $('#settingsModal').children[0]) closeSettings();
      });
      $('#btnApplySettings').addEventListener('click', applySettingsFromModal);
      $('#btnHardReset').addEventListener('click', () => {
        if (!confirm('Reset everything?')) return;
        hardResetAll();
        renderAll();
        scheduleMarketRefresh(true);
        scheduleChartRefresh(true);
        toast('Reset complete', 'ok');
        closeSettings();
      });

      $('#btnReset').addEventListener('click', () => {
        if (!confirm('Reset portfolio and cancel all orders?')) return;
        resetPortfolio();
        saveState();
        renderAll();
        toast('Portfolio reset', 'ok');
      });

      $('#btnRefreshMarket').addEventListener('click', () => refreshMarketOnce());
      $('#btnSetSymbol').addEventListener('click', () => setSymbol($('#symbolInput').value, { user: true }));
      $('#symbolInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') setSymbol($('#symbolInput').value, { user: true });
      });

      // Buy panel events
      $('#buyPriceInput').addEventListener('input', renderTradePreview);
      $('#buyAmountInput').addEventListener('input', renderTradePreview);
      $('#btnBuyMarket').addEventListener('click', () => {
        $('#buyPriceInput').value = '';
        renderTradePreview();
      });
      
      $('#buyQuickBtns').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-pct]');
        if (!btn) return;
        const pct = parseFloat(btn.dataset.pct);
        const limitPrice = safeNum($('#buyPriceInput').value);
        const price = (Number.isFinite(limitPrice) && limitPrice > 0) ? limitPrice : live.bestAsk;
        const feeRate = feeRateFromBps(state.settings.feeBps);
        const cash = getAvailableCash();
        if (Number.isFinite(price) && price > 0) {
          const amount = (cash * pct) / (price * (1 + feeRate));
          $('#buyAmountInput').value = amount;
          renderTradePreview();
        }
      });

      $('#btnBuy').addEventListener('click', async () => {
        const sym = state.ui.symbol;
        if (!canTradeSymbol(sym)) {
          toast(`Symbol must end with ${state.settings.target}`, 'warn');
          return;
        }
        const amount = safeNum($('#buyAmountInput').value);
        const limitPrice = safeNum($('#buyPriceInput').value);
        try {
          const result = await placeOrder('buy', sym, amount, limitPrice);
          $('#buyAmountInput').value = '';
          renderAll();
          if (result.filled) {
            toast(`Bought ${fmtAmount(amount)} ${parseSymbol(sym).base} @ ${fmtMoney(result.result.price, state.settings.target)}`, 'ok');
          } else {
            toast(`Order queued: waiting for price ≤ ${fmtMoney(limitPrice, state.settings.target)}`, 'info');
          }
        } catch (e) {
          toast(e.message, 'err');
        }
      });

      // Sell panel events
      $('#sellPriceInput').addEventListener('input', renderTradePreview);
      $('#sellAmountInput').addEventListener('input', renderTradePreview);
      $('#btnSellMarket').addEventListener('click', () => {
        $('#sellPriceInput').value = '';
        renderTradePreview();
      });
      
      $('#sellQuickBtns').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-pct]');
        if (!btn) return;
        const pct = parseFloat(btn.dataset.pct);
        const sym = state.ui.symbol;
        const p = parseSymbol(sym);
        const available = getAvailableAsset(p.base);
        $('#sellAmountInput').value = available * pct;
        renderTradePreview();
      });

      $('#btnSell').addEventListener('click', async () => {
        const sym = state.ui.symbol;
        if (!canTradeSymbol(sym)) {
          toast(`Symbol must end with ${state.settings.target}`, 'warn');
          return;
        }
        const amount = safeNum($('#sellAmountInput').value);
        const limitPrice = safeNum($('#sellPriceInput').value);
        try {
          const result = await placeOrder('sell', sym, amount, limitPrice);
          $('#sellAmountInput').value = '';
          renderAll();
          if (result.filled) {
            toast(`Sold ${fmtAmount(amount)} ${parseSymbol(sym).base} @ ${fmtMoney(result.result.price, state.settings.target)}`, 'ok');
          } else {
            toast(`Order queued: waiting for price ≥ ${fmtMoney(limitPrice, state.settings.target)}`, 'info');
          }
        } catch (e) {
          toast(e.message, 'err');
        }
      });

      // Open orders
      $('#btnCancelAllOrders').addEventListener('click', () => {
        if (state.pendingOrders.length === 0) return;
        if (!confirm(`Cancel all ${state.pendingOrders.length} open orders?`)) return;
        const count = cancelAllOrders();
        toast(`Cancelled ${count} orders`, 'ok');
        renderAll();
      });

      $('#btnClearHistory').addEventListener('click', () => {
        if (!confirm('Clear trade history?')) return;
        state.history = [];
        saveState();
        renderHistory();
        toast('History cleared', 'ok');
      });

      $('#btnRefreshPrices').addEventListener('click', refreshPortfolioPrices);

      $('#resolution').addEventListener('change', () => {
        state.ui.resolution = $('#resolution').value;
        saveState();
        scheduleChartRefresh(true);
      });
      $('#btnReloadChart').addEventListener('click', () => scheduleChartRefresh(true));

      window.addEventListener('resize', () => scheduleChartRefresh(true));

      $('#btnExport').addEventListener('click', exportState);
      $('#btnImport').addEventListener('click', openImport);
      $('#btnCloseImport').addEventListener('click', closeImport);
      $('#btnCancelImport').addEventListener('click', closeImport);
      $('#btnDoImport').addEventListener('click', doImport);
      $('#importModal').addEventListener('click', (e) => {
        if (e.target === $('#importModal').children[0]) closeImport();
      });
    }

    // Boot
    async function boot() {
      state = loadState();

      const p = parseSymbol(state.ui.symbol);
      if (!p.quote || p.quote !== state.settings.target) {
        state.ui.symbol = state.settings.defaultSymbol || `BTC${state.settings.target}`;
      }

      $('#symbolInput').value = state.ui.symbol;
      $('#resolution').value = state.ui.resolution || '60';

      wireEvents();
      renderAll();

      if (!localStorage.getItem(LS_KEY)) {
        openSettings();
        toast('Configure your settings to start', 'info', 3200);
      }

      scheduleMarketRefresh(true);
      scheduleChartRefresh(true);
      schedulePendingOrdersCheck();

      // Check pending orders on startup
      if (state.pendingOrders.length > 0) {
        setTimeout(() => checkPendingOrders(), 2000);
      }

      setTimeout(() => {
        if (Object.keys(state.holdings).length) refreshPortfolioPrices();
      }, 1200);
    }

    boot();
  </script>
</body>
</html>